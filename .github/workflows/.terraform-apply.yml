name: .terraform-apply

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Environment to apply (e.g., development)"
      working_directory:
        required: false
        type: string
        default: "terraform/environments/development"
      artifact_prefix:
        required: false
        type: string
        default: ""
      approval_required:
        required: false
        type: boolean
        default: false
    
    secrets:
      account_id:
        required: true

jobs:
  terraform-apply:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}-${{ (inputs.approval_required == true) && 'apply-approval' || 'apply' }}
    name: operator-requests-${{ inputs.environment }}-apply
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}operator-requests-${{ inputs.environment }}.zip
          path: ${{ inputs.working_directory }}

      - name: Build Static Assets
        run: |
          cd ../../modules/operator-request-portal-static-site/files
          npm install
          npm run build

      - name: Build Lambda Layer
        run: |
          cd ../../modules/operator-request-portal-lambda-functions/notify-email-communications/files
          mkdir -p notify_layer_package/python zip
          python3 -m pip install -r notify-layer-requirements.txt -t notify_layer_package/python --upgrade

      - name: Assume Role
        run: |
          account_id=${{ secrets.account_id }}
          echo "Assuming role for account ending: ${account_id: -4}"
          
          # Assume the eas-terraformer role
          aws_credentials=$(aws sts assume-role \
            --role-arn arn:aws:iam::${{ secrets.account_id }}:role/eas-terraformer \
            --role-session-name "operator-requests-apply-${{ github.run_id }}" \
            --output json)

          export AWS_ACCESS_KEY_ID=$(echo $aws_credentials | jq '.Credentials.AccessKeyId' | tr -d '"')
          export AWS_SECRET_ACCESS_KEY=$(echo $aws_credentials | jq '.Credentials.SecretAccessKey' | tr -d '"')
          export AWS_SESSION_TOKEN=$(echo $aws_credentials | jq '.Credentials.SessionToken' | tr -d '"')

          if [[ -z $AWS_ACCESS_KEY_ID ]] || [[ "$AWS_ACCESS_KEY_ID" == "" ]]; then
            echo "Access Key Id was not able to be retrieved."
            exit 1
          fi

          if [[ -z $AWS_SECRET_ACCESS_KEY ]] || [[ "$AWS_SECRET_ACCESS_KEY" == "" ]]; then
            echo "Secret Access Key was not able to be retrieved."
            exit 1
          fi

          if [[ -z $AWS_SESSION_TOKEN ]] || [[ "$AWS_SESSION_TOKEN" == "" ]]; then
            echo "Session Token was not able to be retrieved."
            exit 1
          fi

          echo "::add-mask::$AWS_ACCESS_KEY_ID"
          echo "::add-mask::$AWS_SECRET_ACCESS_KEY"
          echo "::add-mask::$AWS_SESSION_TOKEN"

          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> $GITHUB_ENV

      - name: Terraform Apply
        run: |
          unzip -o -q ${{ inputs.artifact_prefix }}operator-requests-${{ inputs.environment }}.zip
          
          echo "Applying Terraform for ${{ inputs.environment }}..."
          terraform apply ${{ inputs.artifact_prefix }}operator-requests-${{ inputs.environment }}.tfplan

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Terraform apply failed for ${{ inputs.environment }}"